<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Fashion Hub - Your Style Destination</title>
        <link rel="stylesheet" href="../../assets/css/profilepage.css" />
    </head>
    <body>
        <!-- Header -->
        <header>
            <nav>
                <div class="logo">Fashion Hub</div>
                <ul class="nav-links">
                    <li><a href="../index.html">Home</a></li>
                    <li><a href="#" onclick="showSection('products')">Shop</a></li>
                    <li><a href="#" onclick="showSection('about')">About</a></li>
                </ul>
                <div class="nav-icons">
                    <button id="authBtn">üë§</button>

                    <button onclick="toggleCart()">
                        üõí
                        <span class="cart-badge" id="cartCount">0</span>
                    </button>

                    <div class="user-dropdown hidden" id="userDropdown">
                        <ul class="dropdown-menu">
                            <li>
                                <a href="src/b/profile.html" class="dropdown-item" id="profileBtn">
                                    <span class="icon">üë§</span>
                                    <span>Profile</span>
                                </a>
                            </li>
                            <li>
                                <button class="dropdown-item logout" id="logoutBtn">
                                    <span class="icon">üö™</span>
                                    <span>Sign Out</span>
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </header>

        <div class="profile-container">
            <div class="orders-section">
                <div class="section-header">
                    <h3>My Orders</h3>
                    <div class="filter-tabs">
                        <button class="tab active" data-filter="all">All</button>
                        <button class="tab" data-filter="Processing">Processing</button>
                        <button class="tab" data-filter="In-transit">In Transit</button>
                        <button class="tab" data-filter="Delivered">Delivered</button>
                    </div>
                </div>

                <div id="ordersContainer">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading your orders...</p>
                    </div>
                </div>
            </div>
        </div>

        <script type="module">
            import { auth, db } from '../firebase.js';
            import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
            import {
                collection,
                query,
                where,
                getDocs,
                orderBy,
            } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

            let currentFilter = 'all';
            let allOrders = [];

            // Check if there's a pending order to complete
            const pendingOrderId = sessionStorage.getItem('pendingOrderId');
            if (pendingOrderId) {
                // Load order details from Firestore
                // Populate cart with order items
                // Remove the session storage item after loading
                sessionStorage.removeItem('pendingOrderId');
            }

            // Check authentication
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    // User not logged in, redirect to login page
                    window.location.href = 'index.html';
                    return;
                }

                // // Display user info
                // document.getElementById('userName').textContent = user.displayName || 'User';
                // document.getElementById('userEmail').textContent = user.email;

                // // Set avatar initial
                // const initial = (user.displayName || user.email).charAt(0).toUpperCase();
                // document.getElementById('userAvatar').textContent = initial;

                // Load user's orders
                await loadUserOrders(user.uid);
            });

            async function loadUserOrders(userId) {
                const ordersContainer = document.getElementById('ordersContainer');

                try {
                    const ordersRef = collection(db, 'orders');
                    // Remove orderBy temporarily - sort client-side instead
                    const q = query(ordersRef, where('userId', '==', userId));

                    const querySnapshot = await getDocs(q);

                    allOrders = [];
                    querySnapshot.forEach((doc) => {
                        allOrders.push({ id: doc.id, ...doc.data() });
                    });

                    // Sort on client side
                    allOrders.sort((a, b) => {
                        const dateA = a.createdAt?.toDate?.() || new Date(0);
                        const dateB = b.createdAt?.toDate?.() || new Date(0);
                        return dateB - dateA; // Descending order
                    });

                    displayOrders(allOrders);
                } catch (error) {
                    console.error('Error loading orders:', error);
                    ordersContainer.innerHTML = `
            <div class="no-orders">
                <div class="no-orders-icon">‚ö†Ô∏è</div>
                <h3>Error Loading Orders</h3>
                <p>Something went wrong. Please try again later.</p>
            </div>
        `;
                }
            }
            // Display orders
            function displayOrders(orders) {
                const ordersContainer = document.getElementById('ordersContainer');

                if (orders.length === 0) {
                    ordersContainer.innerHTML = `
                    <div class="no-orders">
                        <div class="no-orders-icon">üì¶</div>
                        <h3>No Orders Yet</h3>
                        <p>You haven't placed any orders. Start shopping!</p>
                        <br>
                        <a href="index.html" class="btn btn-primary">Start Shopping</a>
                    </div>
                `;
                    return;
                }

                ordersContainer.innerHTML = orders
                    .map((order) => {
                        const createdDate = order.createdAt?.toDate
                            ? order.createdAt.toDate().toLocaleDateString('en-US', {
                                  year: 'numeric',
                                  month: 'short',
                                  day: 'numeric',
                              })
                            : 'N/A';

                        const items = order.items || [];
                        const subtotal = items.reduce((sum, item) => sum + item.price * item.quantity, 0);
                        const shipping = order.shipping || 50;
                        const tax = order.tax || subtotal * 0.12;
                        const total = subtotal + shipping + tax;

                        console.log(' item.image', items);
                        return `
                    <div class="order-card">
                        <div class="order-header">
                            <div>
                                <div class="order-number">Order #${order.orderNumber || order.id}</div>
                                <div class="order-date">${createdDate}</div>
                            </div>
                            <div class="order-badges">
                                <span class="badge ${order.paymentStatus?.toLowerCase()}">${order.paymentStatus || 'Pending'}</span>
                                <span class="badge ${order.orderStatus?.toLowerCase().replace('-', '')}">${order.orderStatus || 'Processing'}</span>
                            </div>
                        </div>

                        <div class="order-items">
                            ${items
                                .map(
                                    (item) => `
                                <div class="order-item">
                                    <div class="item-image">
                                  ${
                                      item.image
                                          ? `<img src="/${item.image}" alt="${item.name}">`
                                          : `
                                        <svg width="120" height="120" viewBox="0 0 120 120" fill="none">
                                            <rect width="120" height="120" fill="#e9ecef"/>
                                            <path d="M35 40h50v5h-50zM35 50h15v35h-15zM55 50h30v35h-30z" fill="#adb5bd"/>
                                        </svg>`
                                  }
                                    </div>
                                    <div class="item-details">
                                        <div class="item-name">${item.name}</div>
                                        ${item.variant ? `<div class="item-variant">${item.variant}</div>` : ''}
                                        <div class="item-price">Qty: ${item.quantity} √ó ‚Ç±${item.price.toFixed(2)}</div>
                                    </div>
                                </div>
                            `,
                                )
                                .join('')}
                        </div>

                        <div class="order-total">
                            <span class="total-label">Total Amount</span>
                            <span class="total-amount">‚Ç±${total.toFixed(2)}</span>
                        </div>
                    </div>
                `;
                    })
                    .join('');
            }

            // Filter tabs
            document.querySelectorAll('.tab').forEach((tab) => {
                tab.addEventListener('click', () => {
                    // Update active tab
                    document.querySelectorAll('.tab').forEach((t) => t.classList.remove('active'));
                    tab.classList.add('active');

                    // Filter orders
                    currentFilter = tab.dataset.filter;
                    const filteredOrders =
                        currentFilter === 'all'
                            ? allOrders
                            : allOrders.filter((order) => order.orderStatus === currentFilter);

                    displayOrders(filteredOrders);
                });
            });

            // Logout functionality
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    window.location.href = 'index.php';
                } catch (error) {
                    console.error('Error signing out:', error);
                    alert('Error signing out. Please try again.');
                }
            });
        </script>
        <script type="module" src="../../public/js/main.js"></script>
    </body>
</html>
